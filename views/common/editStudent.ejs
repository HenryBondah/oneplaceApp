
<body>
    <% if (messages && messages.success && messages.success.length > 0) { %>
        <div class="flash-message flash-success"><%= messages.success %></div>
    <% } %>
    <% if (messages && messages.error && messages.error.length > 0) { %>
        <div class="flash-message flash-error"><%= messages.error %></div>
    <% } %>
    <div class="link-to-next-back">
        <a href="/common/studentDetails?studentId=<%= student.student_id %>" class="btn btn-primary">Back</a>
    </div>
    <hr>
    <main class="edit-student-container">
        <h1>Edit Student</h1>
        <form action="/common/editStudent/<%= student.student_id %>" method="POST" enctype="multipart/form-data">
                <legend>Select Class & Subject (Required)</legend>
                <div class="form-group">
                    <label for="firstName">Student First Name:</label>
                    <input type="text" id="firstName" name="firstName" value="<%= student.first_name %>" required>
                </div>
                <div class="form-group">
                    <label for="lastName">Student Last Name:</label>
                    <input type="text" id="lastName" name="lastName" value="<%= student.last_name %>" required>
                </div>
                <div class="form-group">
                    <label for="dateOfBirth">Date of Birth:</label>
                    <input type="date" id="dateOfBirth" name="dateOfBirth" value="<%= student.date_of_birth.toISOString().split('T')[0] %>" required>
                </div>
                <div class="form-group">
                    <label for="height">Student Height (cm):</label>
                    <input type="number" id="height" name="height" value="<%= student.height %>">
                </div>
                <div class="form-group">
                    <label for="hometown">Student Hometown:</label>
                    <input type="text" id="hometown" name="hometown" value="<%= student.hometown %>">
                </div>
                <div class="form-group">
                    <label for="classSelect">Class:</label>
                    <select id="classSelect" name="classId" required>
                        <option value="">Select a Class</option>
                        <% classes.forEach(function(cls) { %>
                            <option value="<%= cls.class_id %>" <%= cls.class_id === student.class_id ? 'selected' : '' %>><%= cls.class_name %></option>
                        <% }); %>
                    </select>
                </div>
                <div class="form-group">
                    <label for="subjectSelect">Subjects:</label>
                    <div>
                        <input type="checkbox" id="selectAllSubjects">
                        <label for="selectAllSubjects">Select All Subjects</label>
                    </div>
                    <div id="subjectContainer">
                        <% subjects.forEach(function(subject) { %>
                            <div>
                                <input type="checkbox" name="subjects[]" value="<%= subject.subject_id %>" id="subject<%= subject.subject_id %>" <%= enrolledSubjects.includes(subject.subject_id) ? 'checked' : '' %>>
                                <label for="subject<%= subject.subject_id %>"><%= subject.subject_name %></label>
                            </div>
                        <% }); %>
                    </div>
                </div>

                <div class="form-group">
                    <label for="graduationYearGroupSelect">Graduation Year Group:</label>
                    <select name="graduationYearGroupId" id="graduationYearGroupSelect" required>
                        <option value="">Select Graduation Year Group</option>
                        <% graduationYearGroups.forEach(function(group) { %>
                            <option value="<%= group.id %>" <%= group.id === student.graduation_year_group_id ? 'selected' : '' %>><%= group.name %></option>
                        <% }); %>
                    </select>
                </div>
                <div class="form-group">
                    <label for="studentImage">Student Image (Optional):</label>
                    <input type="file" id="studentImage" name="studentImage" accept="image/*">
                    <% if (student.image_url) { %>
                        <img src="/<%= student.image_url %>" alt="Student Image" class="student-image">
                    <% } %>
                </div>
    
            
            <br>

            <fieldset>
                <legend>Guardians</legend>
                <div id="guardians-container">
                    <% guardians.forEach(function(guardian, index) { %>
                        <div class="guardian">
                            <div>
                                <label>Guardian <%= index + 1 %> First Name:</label>
                                <input type="text" name="guardians[<%= index %>][firstName]" value="<%= guardian.first_name %>">
                            </div>
                            <div>
                                <label>Guardian <%= index + 1 %> Last Name:</label>
                                <input type="text" name="guardians[<%= index %>][lastName]" value="<%= guardian.last_name %>">
                            </div>
                            <div>
                                <label>Guardian <%= index + 1 %> Address:</label>
                                <input type="text" name="guardians[<%= index %>][address]" value="<%= guardian.address %>">
                            </div>
                            <div>
                                <label>Guardian <%= index + 1 %> Phone:</label>
                                <input type="text" name="guardians[<%= index %>][phone]" value="<%= guardian.phone %>">
                            </div>
                            <div>
                                <label>Guardian <%= index + 1 %> Hometown:</label>
                                <input type="text" name="guardians[<%= index %>][hometown]" value="<%= guardian.hometown %>">
                            </div>
                        </div>
                    <% }); %>
                </div>
                <button type="button" onclick="addGuardian()">Add Another Guardian</button>
            </fieldset>



            <button type="submit">Update Student</button>
            <form action="/common/deleteStudent/<%= student.student_id %>" method="post" onsubmit="return confirm('Are you sure you want to delete this student?');">
                <button type="submit" class="btn-delete">Delete Student</button>
            </form>
        </form>

        
    </main>

    <script>
        let guardianCount = <%= guardians.length %>;

        function addGuardian() {
            const container = document.getElementById('guardians-container');

            const guardianDiv = document.createElement('div');
            guardianDiv.classList.add('guardian');

            guardianDiv.innerHTML = `
                <div>
                    <label>Guardian ${guardianCount + 1} First Name:</label>
                    <input type="text" name="guardians[${guardianCount}][firstName]">
                </div>
                <div>
                    <label>Guardian ${guardianCount + 1} Last Name:</label>
                    <input type="text" name="guardians[${guardianCount}][lastName]">
                </div>
                <div>
                    <label>Guardian ${guardianCount + 1} Address:</label>
                    <input type="text" name="guardians[${guardianCount}][address]">
                </div>
                <div>
                    <label>Guardian ${guardianCount + 1} Phone:</label>
                    <input type="text" name="guardians[${guardianCount}][phone]">
                </div>
                <div>
                    <label>Guardian ${guardianCount + 1} Hometown:</label>
                    <input type="text" name="guardians[${guardianCount}][hometown]">
                </div>
            `;

            container.appendChild(guardianDiv);
            guardianCount++;
        }

        document.getElementById('selectAllSubjects').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('input[name="subjects[]"]');
            checkboxes.forEach(checkbox => checkbox.checked = this.checked);
        });

        document.getElementById('classSelect').addEventListener('change', async function() {
            const classId = this.value;
            const graduationYearGroupSelect = document.getElementById('graduationYearGroupSelect');
            const warningMessage = document.getElementById('graduationYearGroupWarning');
            const subjectsContainer = document.getElementById('subjectContainer');

            if (!classId) {
                graduationYearGroupSelect.value = '';
                warningMessage.style.display = 'none';
                subjectsContainer.innerHTML = '<p>Select a class to load subjects.</p>';
                return;
            }

            try {
                // Fetch majority graduation year group
                const response = await fetch(`/common/getMajorityGraduationYearGroup?classId=${classId}`);
                const data = await response.json();

                if (data.majorityGraduationYearGroupId) {
                    graduationYearGroupSelect.value = data.majorityGraduationYearGroupId;
                    warningMessage.style.display = 'none';
                } else {
                    graduationYearGroupSelect.value = '';
                }

                // Fetch subjects for the selected class
                const subjectsResponse = await fetch(`/common/getSubjectsForClass?classId=${classId}`);
                const subjectsData = await subjectsResponse.json();

                if (subjectsData.length > 0) {
                    let subjectsHtml = '<label><input type="checkbox" id="selectAllSubjects"> Select All</label><br>';
                    subjectsData.forEach(subject => {
                        subjectsHtml += `<label><input type="checkbox" name="subjects[]" value="${subject.subject_id}"> ${subject.subject_name}</label><br>`;
                    });
                    subjectsContainer.innerHTML = subjectsHtml;

                    document.getElementById('selectAllSubjects').addEventListener('change', function() {
                        const checkboxes = subjectsContainer.querySelectorAll('input[name="subjects[]"]');
                        checkboxes.forEach(checkbox => checkbox.checked = this.checked);
                    });
                } else {
                    subjectsContainer.innerHTML = '<p>No subjects found for the selected class.</p>';
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                graduationYearGroupSelect.value = '';
                warningMessage.style.display = 'none';
                subjectsContainer.innerHTML = '<p>Failed to load subjects.</p>';
            }
        });

        document.getElementById('graduationYearGroupSelect').addEventListener('change', function() {
            const classId = document.getElementById('classSelect').value;
            const graduationYearGroupId = this.value;
            const warningMessage = document.getElementById('graduationYearGroupWarning');

            if (classId && graduationYearGroupId) {
                fetch(`/common/getMajorityGraduationYearGroup?classId=${classId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.majorityGraduationYearGroupId && data.majorityGraduationYearGroupId != graduationYearGroupId) {
                            warningMessage.style.display = 'block';
                        } else {
                            warningMessage.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching majority graduation year group:', error);
                        warningMessage.style.display = 'none';
                    });
            } else {
                warningMessage.style.display = 'none';
            }
        });
    </script>
