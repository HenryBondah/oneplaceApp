<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Attendance</title>
    <link rel="stylesheet" href="/stylesheets/style.css">
    <style>
        .icon {
            cursor: pointer;
            margin: 0 5px;
        }
        .edit-save-link {
            text-align: center;
        }
        .attendance-action {
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>
    <h1>Attendance for Class <%= className %></h1>
    <div class="attendance-sheet-container">
        <table class="attendance-sheet">
            <thead>
                <tr>
                    <th class="student-name">Student Name</th>
                    <% dates.forEach(date => { %>
                        <th>
                            <%= new Date(date).toLocaleDateString() %>
                            <div class="attendance-action" data-date="<%= date %>">
                                <span class="icon save-btn" data-date="<%= date %>" onclick="saveAttendanceForDate('<%= date %>')" style="display: none;">✔</span>
                                <span class="icon edit-btn" data-date="<%= date %>" onclick="toggleEditSaveMode('<%= date %>')" style="display: inline;">✎</span>
                                <span class="icon cancel-btn" data-date="<%= date %>" onclick="cancelEditMode('<%= date %>')" style="display: none;">✖</span>
                            </div>
                        </th>
                    <% }); %>
                    <th class="total-attendance">Total</th>
                </tr>
            </thead>
            <tbody>
                <% students.forEach(student => { %>
                    <tr>
                        <td class="student-name"><%= student.first_name %> <%= student.last_name %></td>
                        <% dates.forEach(date => { %>
                            <td>
                                <input type="checkbox" data-date="<%= date %>" data-student-id="<%= student.student_id %>" 
                                    <%= attendanceMap[student.student_id] && attendanceMap[student.student_id][date] === 'Present' ? 'checked' : '' %> 
                                    <%= attendanceMap[student.student_id] && attendanceMap[student.student_id][date] ? 'disabled' : '' %> >
                            </td>
                        <% }); %>
                        <td class="total-attendance"><%= attendanceMap[student.student_id] ? Object.values(attendanceMap[student.student_id]).filter(status => status === 'Present').length : 0 %> / <%= dates.length %></td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
    <script>
        function toggleEditSaveMode(date) {
            const checkboxes = document.querySelectorAll(input[data-date='${date}']);
            const saveBtn = document.querySelector(.save-btn[data-date='${date}']);
            const editBtn = document.querySelector(.edit-btn[data-date='${date}']);
            const cancelBtn = document.querySelector(.cancel-btn[data-date='${date}']);

            checkboxes.forEach(checkbox => {
                checkbox.disabled = !checkbox.disabled;
            });
            saveBtn.style.display = saveBtn.style.display === 'none' ? 'inline' : 'none';
            editBtn.style.display = editBtn.style.display === 'none' ? 'inline' : 'none';
            cancelBtn.style.display = cancelBtn.style.display === 'none' ? 'inline' : 'none';
        }

        function saveAttendanceForDate(date) {
            const checkboxes = document.querySelectorAll(input[data-date='${date}']);
            const saveBtn = document.querySelector(.save-btn[data-date='${date}']);
            const editBtn = document.querySelector(.edit-btn[data-date='${date}']);
            const cancelBtn = document.querySelector(.cancel-btn[data-date='${date}']);

            const attendanceData = [];

            checkboxes.forEach(checkbox => {
                attendanceData.push({
                    studentId: checkbox.dataset.studentId,
                    date: date,
                    status: checkbox.checked ? 'Present' : 'Absent'
                });
            });

            fetch('/common/saveAttendanceForDate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ attendance: attendanceData, classId: '<%= classId %>' }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(Attendance for ${date} saved successfully!);
                    checkboxes.forEach(checkbox => {
                        checkbox.disabled = true;
                    });
                    saveBtn.style.display = 'none';
                    editBtn.style.display = 'inline';
                    cancelBtn.style.display = 'none';
                } else {
                    alert('Failed to save attendance. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error saving attendance:', error);
                alert('Failed to save attendance. Please try again.');
            });
        }

        function cancelEditMode(date) {
            const checkboxes = document.querySelectorAll(input[data-date='${date}']);
            const saveBtn = document.querySelector(.save-btn[data-date='${date}']);
            const editBtn = document.querySelector(.edit-btn[data-date='${date}']);
            const cancelBtn = document.querySelector(.cancel-btn[data-date='${date}']);

            checkboxes.forEach(checkbox => {
                checkbox.disabled = true;
                checkbox.checked = checkbox.defaultChecked;
            });
            saveBtn.style.display = 'none';
            editBtn.style.display = 'inline';
            cancelBtn.style.display = 'none';
        }
    </script>
</body>
</html>